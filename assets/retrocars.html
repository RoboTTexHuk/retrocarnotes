<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover"
    />
    <title>Retronotes Garage Tracker</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-3.1.1.min.js"></script>

    <!-- Icons -->
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ["system-ui", "sans-serif"],
              },
              colors: {
                retro: {
                  bg: "#020617",
                  card: "#020617",
                  cardSoft: "#030712",
                  cardBorder: "#1e293b",
                  primary: "#ff4d4d",
                  secondary: "#4d96ff",
                  text: "#e2e8f0",
                  muted: "#64748b",
                },
              },
            },
          },
        };
    </script>

    <style>
        html,
        body {
          margin: 0;
          padding: 0;
          height: 100%;
          background: radial-gradient(
            circle at top,
            #111827 0,
            #020617 55%,
            #000 100%
          );
        }

        .device-frame {
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 16px;
        }

        .device-inner {
          position: relative;
          width: 100%;
          max-width: 1000px;
          height: 100vh;
          max-height: 900px;
          border-radius: 32px;
          background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
          box-shadow: 0 40px 120px rgba(0, 0, 0, 0.9);
          color: #e2e8f0;
          overflow: hidden;
        }

        .app-scroll {
          height: 100%;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }

        .glass-top {
          background: rgba(15, 23, 42, 0.95);
          backdrop-filter: blur(16px);
          border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        }

        .glass-bottom {
          background: linear-gradient(
            to top,
            rgba(15, 23, 42, 0.98),
            rgba(15, 23, 42, 0.92)
          );
          backdrop-filter: blur(18px);
          border-top: 1px solid rgba(148, 163, 184, 0.25);
        }

        .tab-page {
          display: none;
          padding: 1.5rem 1.25rem 5.5rem;
        }
        .tab-page.active {
          display: block;
        }

        .modal-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(15, 23, 42, 0.78);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 50;
        }

        input,
        textarea,
        select,
        button {
          outline: none;
          -webkit-tap-highlight-color: transparent;
        }

        button {
          cursor: pointer;
        }
    </style>
</head>
<body class="font-sans antialiased text-retro-text">
<div class="device-frame">
    <div class="device-inner">
        <div class="app-scroll">
            <!-- HEADER -->
            <header
                    id="app-header"
                    class="glass-top fixed top-0 inset-x-0 mx-auto h-16 flex items-center justify-between px-6 z-40"
                    style="max-width: 1000px"
            >
                <div class="flex items-center gap-3">
                    <div
                            class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-retro-primary via-red-500 to-orange-400 flex items-center justify-center shadow-lg"
                    >
                        <i class="fa-solid fa-car-side text-white text-base"></i>
                    </div>
                    <div class="leading-tight">
                        <div class="font-extrabold text-lg tracking-wider">
                            RETRO<span class="text-retro-secondary">NOTES</span>
                        </div>
                        <div class="text-[10px] text-retro-muted -mt-[2px]">
                            Garage tracker
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button
                            id="header-search"
                            type="button"
                            class="w-9 h-9 rounded-full bg-retro-card border border-retro-cardBorder text-retro-muted hover:text-white flex items-center justify-center text-sm"
                            title="Search notes"
                    >
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>

                    <!-- AVATAR -->
                    <button
                            id="avatar-button"
                            type="button"
                            class="w-9 h-9 rounded-full border-2 border-retro-cardBorder overflow-hidden relative group"
                            title="Change profile photo"
                    >
                        <img
                                id="avatar-img"
                                src="https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&w=80"
                                class="w-full h-full object-cover"
                                alt="avatar"
                                draggable="false"
                        />
                        <div
                                class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-[10px] text-slate-200 transition-opacity"
                        >
                            <i class="fa-solid fa-camera"></i>
                        </div>
                    </button>

                    <input
                            id="avatar-input"
                            type="file"
                            accept="image/*"
                            class="hidden"
                    />
                </div>
            </header>

            <!-- MAIN -->
            <main class="pt-16 pb-20 bg-retro-bg min-h-full">
                <!-- GARAGE TAB -->
                <section id="tab-garage" class="tab-page active">
                    <div class="flex items-baseline justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold mb-1">My Garage</h2>
                            <p id="garage-summary" class="text-xs text-retro-muted">–</p>
                        </div>
                        <button
                                id="btn-open-add-car"
                                type="button"
                                class="flex items-center gap-1 px-4 py-2 rounded-full bg-retro-secondary text-slate-950 text-xs font-semibold shadow-lg hover:brightness-105 active:scale-[0.97] transition"
                        >
                            <i class="fa-solid fa-plus text-[10px]"></i>
                            Add Car
                        </button>
                    </div>

                    <div id="garage-list" class="space-y-5"></div>
                </section>

                <!-- NOTES TAB -->
                <section id="tab-notes" class="tab-page">
                    <div class="flex items-baseline justify-between mb-3">
                        <div>
                            <h2 class="text-2xl font-bold mb-1">Notes Timeline</h2>
                            <p class="text-xs text-retro-muted">
                                Work logs, ideas, parts & todos
                            </p>
                        </div>
                        <button
                                id="btn-open-add-note-global"
                                type="button"
                                class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-retro-secondary text-slate-950 text-xs font-semibold shadow hover:brightness-105 active:scale-[0.97] transition"
                        >
                            <i class="fa-solid fa-plus text-[10px]"></i>
                            Add Note
                        </button>
                    </div>

                    <div class="relative mb-3">
                        <i
                                class="fa-solid fa-magnifying-glass text-xs text-retro-muted absolute left-3 top-1/2 -translate-y-1/2"
                        ></i>
                        <input
                                id="notes-search"
                                class="w-full bg-retro-card border border-retro-cardBorder rounded-xl py-2.5 pl-9 pr-3 text-xs placeholder:text-retro-muted"
                                placeholder="Search notes, cars, tags…"
                        />
                    </div>

                    <div class="flex items-center gap-2 text-[11px] text-retro-muted mb-2">
                        <button
                                type="button"
                                id="btn-notes-filter-todos"
                                class="px-2 py-1 rounded-full bg-retro-card border border-retro-cardBorder text-[10px] flex items-center gap-1"
                        >
                            <i class="fa-solid fa-filter text-[9px]"></i>
                            <span>Show todos only</span>
                        </button>
                        <span class="flex-1 text-right">
              Sorted by <span class="text-retro-text">Newest first</span>
            </span>
                    </div>

                    <div id="notes-list" class="space-y-3 text-xs mb-4"></div>
                </section>

                <!-- ANALYTICS TAB -->
                <section id="tab-analytics" class="tab-page">
                    <h2 class="text-2xl font-bold mb-1">Analytics</h2>
                    <p class="text-xs text-retro-muted mb-5">
                        Spending, value & restoration progress
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-5 text-xs">
                        <div
                                class="bg-retro-card border border-retro-cardBorder rounded-xl p-3 flex flex-col justify-between"
                        >
                            <div class="text-retro-muted mb-0.5">Garage value</div>
                            <div id="total-value" class="text-lg font-semibold">$0</div>
                            <div class="text-[10px] text-emerald-400 mt-0.5">
                                <i class="fa-solid fa-arrow-trend-up mr-1"></i><span id="sample-growth">sample +12% YTD</span>
                            </div>
                        </div>
                        <div
                                class="bg-retro-card border border-retro-cardBorder rounded-xl p-3 flex flex-col justify-between"
                        >
                            <div class="text-retro-muted mb-0.5">Total notes</div>
                            <div id="total-notes" class="text-lg font-semibold">0</div>
                            <div class="text-[10px] text-retro-muted mt-0.5">
                                Based on your logbook
                            </div>
                        </div>
                    </div>

                    <div
                            class="bg-retro-card border border-retro-cardBorder rounded-2xl p-4 mb-5"
                    >
                        <div class="flex justify-between items-center mb-3 text-xs">
                            <div class="font-semibold">Spending by category</div>
                            <span class="text-retro-muted text-[11px]"
                            >Sample this year</span
                            >
                        </div>
                        <div id="analytics-pie" class="w-full" style="height: 220px"></div>
                    </div>

                    <div
                            class="bg-retro-card border border-retro-cardBorder rounded-2xl p-4 mb-5"
                    >
                        <div class="flex justify-between items-center mb-3 text-xs">
                            <div class="font-semibold">Monthly expenses</div>
                            <span class="text-retro-muted text-[11px]"
                            >Last 6 months (sample)</span
                            >
                        </div>
                        <div
                                id="analytics-line"
                                class="w-full"
                                style="height: 220px"
                        ></div>
                    </div>

                    <!-- Radar: уникальная визуализация состояния гаража -->
                    <div
                            class="bg-retro-card border border-retro-cardBorder rounded-2xl p-4 mb-5"
                    >
                        <div class="flex justify-between items-center mb-3 text-xs">
                            <div class="font-semibold">Garage health radar</div>
                            <span class="text-retro-muted text-[11px]"
                            >Based on your data</span
                            >
                        </div>
                        <div
                                id="analytics-radar"
                                class="w-full"
                                style="height: 220px"
                        ></div>
                    </div>

                    <!-- Backup / Restore -->
                    <div
                            class="bg-retro-card border border-retro-cardBorder rounded-2xl p-4 mb-5 text-xs"
                    >
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold">Data backup</div>
                            <span class="text-retro-muted text-[11px]">Export / Import</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button
                                    type="button"
                                    id="btn-export-data"
                                    class="px-3 py-1.5 rounded-full bg-slate-800 text-[11px] flex items-center gap-1"
                            >
                                <i class="fa-solid fa-download text-[10px]"></i>
                                <span>Export JSON</span>
                            </button>
                            <label
                                    for="input-import-data"
                                    class="px-3 py-1.5 rounded-full bg-slate-800 text-[11px] flex items-center gap-1 cursor-pointer"
                            >
                                <i class="fa-solid fa-upload text-[10px]"></i>
                                <span>Import JSON</span>
                            </label>
                            <input
                                    id="input-import-data"
                                    type="file"
                                    accept="application/json"
                                    class="hidden"
                            />
                        </div>
                        <p class="mt-2 text-[10px] text-retro-muted">
                            Your garage and notes are stored securely on-device. Use backup to
                            move data between your iPhone and iPad or keep a safety copy.
                        </p>
                    </div>
                </section>

                <!-- TOP CARS TAB -->
                <section id="tab-top-cars" class="tab-page">
                    <h2 class="text-2xl font-bold mb-4">Top Cars</h2>

                    <div
                            id="top-mode-switch"
                            class="flex bg-retro-card border border-retro-cardBorder rounded-xl p-1 text-xs mb-4"
                    >
                        <button
                                type="button"
                                class="flex-1 py-1.5 rounded-lg bg-retro-secondary text-slate-950 font-semibold"
                                data-mode="cost"
                        >
                            Cost / Value
                        </button>
                        <button
                                type="button"
                                class="flex-1 py-1.5 rounded-lg text-retro-muted"
                                data-mode="spending"
                        >
                            Spending
                        </button>
                        <button
                                type="button"
                                class="flex-1 py-1.5 rounded-lg text-retro-muted"
                                data-mode="age"
                        >
                            Age
                        </button>
                    </div>

                    <div
                            id="top-highlight"
                            class="relative bg-retro-card border border-retro-cardBorder rounded-2xl p-4 mb-4 overflow-hidden min-h-[90px]"
                    >
                        <div
                                class="absolute -right-10 -bottom-10 w-40 h-40 bg-retro-secondary/20 rounded-full blur-3xl"
                        ></div>
                        <div class="relative z-10 text-xs">
                            <div
                                    id="top-highlight-badge"
                                    class="inline-flex items-center px-2 py-0.5 rounded-full bg-retro-secondary/20 text-retro-secondary font-semibold text-[10px] mb-2"
                            >
                                <i class="fa-solid fa-crown mr-1"></i>Most valuable
                            </div>
                            <div id="top-highlight-title" class="text-lg font-semibold">
                                –
                            </div>
                            <div id="top-highlight-main" class="text-2xl font-bold">–</div>
                            <div
                                    id="top-highlight-sub"
                                    class="text-[11px] text-retro-muted"
                            >
                                Add cars to see rankings
                            </div>
                        </div>
                    </div>

                    <div id="top-list" class="space-y-2 text-xs"></div>
                </section>
            </main>

            <!-- BOTTOM NAV -->
            <nav
                    id="bottom-nav"
                    class="glass-bottom fixed bottom-0 inset-x-0 mx-auto h-16 flex items-center justify-around px-4 z-40"
                    style="max-width: 1000px"
            >
                <button
                        type="button"
                        class="nav-btn flex flex-col items-center text-retro-secondary text-[11px]"
                        data-target="tab-garage"
                >
                    <i class="fa-solid fa-warehouse text-lg mb-0.5"></i>
                    Garage
                </button>
                <button
                        type="button"
                        class="nav-btn flex flex-col items-center text-retro-muted text-[11px]"
                        data-target="tab-notes"
                >
                    <i class="fa-regular fa-clipboard text-lg mb-0.5"></i>
                    Notes
                </button>
                <button
                        type="button"
                        class="nav-btn flex flex-col items-center text-retro-muted text-[11px]"
                        data-target="tab-analytics"
                >
                    <i class="fa-solid fa-chart-pie text-lg mb-0.5"></i>
                    Analytics
                </button>
                <button
                        type="button"
                        class="nav-btn flex flex-col items-center text-retro-muted text-[11px]"
                        data-target="tab-top-cars"
                >
                    <i class="fa-solid fa-trophy text-lg mb-0.5"></i>
                    Top Cars
                </button>
            </nav>
        </div>
    </div>
</div>

<!-- MODAL ADD CAR -->
<div id="modal-add-car" class="modal-backdrop hidden">
    <div
            class="w-full max-w-md mx-4 bg-retro-card border border-retro-cardBorder rounded-2xl p-5 text-xs shadow-2xl"
    >
        <div class="flex justify-between items-center mb-3">
            <div class="font-semibold text-sm">Add Car</div>
            <button
                    type="button"
                    data-close-modal="modal-add-car"
                    class="text-retro-muted hover:text-retro-text text-sm"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <form id="form-add-car" class="space-y-3">
            <div>
                <label class="block text-[11px] text-retro-muted mb-1">Car name</label>
                <input
                        name="name"
                        required
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                        placeholder="Ford Mustang '67"
                />
            </div>
            <div>
                <label class="block text-[11px] text-retro-muted mb-1"
                >Subtitle (engine / trim)</label
                >
                <input
                        name="subtitle"
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                        placeholder="Fastback GT · 390 V8"
                />
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1">Year</label>
                    <input
                            name="year"
                            type="number"
                            required
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="1967"
                    />
                </div>
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1"
                    >Value, $</label
                    >
                    <input
                            name="value"
                            type="number"
                            min="0"
                            required
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="14500"
                    />
                </div>
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1"
                    >Notes count</label
                    >
                    <input
                            name="notes"
                            type="number"
                            min="0"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="0"
                    />
                </div>
            </div>

            <!-- Maintenance fields -->
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1">Mileage</label>
                    <input
                            name="mileage"
                            type="number"
                            min="0"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="120000"
                    />
                </div>
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1"
                    >Last service (km)</label
                    >
                    <input
                            name="lastServiceMileage"
                            type="number"
                            min="0"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="115000"
                    />
                </div>
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1"
                    >Service interval</label
                    >
                    <input
                            name="serviceIntervalKm"
                            type="number"
                            min="0"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="10000"
                    />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1">Status</label>
                    <select
                            name="status"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                    >
                        <option value="In restoration">In restoration</option>
                        <option value="Complete">Complete</option>
                        <option value="Pending parts">Pending parts</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] text-retro-muted mb-1"
                    >Last updated</label
                    >
                    <input
                            name="updated"
                            class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                            placeholder="2d ago"
                    />
                </div>
            </div>

            <!-- CAR PHOTO -->
            <div>
                <label class="block text-[11px] text-retro-muted mb-1">
                    Car photo (optional)
                </label>
                <div class="flex items-center gap-3 flex-wrap">
                    <!-- Camera (optional, можно включить id при необходимости) -->
                    <!--
                    <button
                      type="button"
                      id="btn-car-photo-camera"
                      class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-slate-800 border border-retro-cardBorder text-[11px] text-retro-muted hover:text-retro-text hover:border-retro-secondary transition"
                    >
                      <i class="fa-solid fa-camera text-[10px]"></i>
                      Camera
                    </button>
                    -->

                    <!-- Gallery -->
                    <button
                            type="button"
                            id="btn-car-photo-gallery"
                            class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-slate-800 border border-retro-cardBorder text-[11px] text-retro-muted hover:text-retro-text hover:border-retro-secondary transition"
                    >
                        <i class="fa-solid fa-image text-[10px]"></i>
                        Gallery
                    </button>

                    <span
                            id="car-photo-filename"
                            class="text-[11px] text-retro-muted line-clamp-1"
                    >
            No photo selected
          </span>
                </div>

                <!-- hidden inputs -->
                <input
                        id="car-photo-input-camera"
                        type="file"
                        accept="image/*"
                        capture="environment"
                        class="hidden"
                />
                <input
                        id="car-photo-input-gallery"
                        type="file"
                        accept="image/*"
                        class="hidden"
                />
                <input type="hidden" name="heroDataUrl" />

                <div
                        id="car-photo-preview-wrapper"
                        class="mt-2 hidden"
                >
                    <div class="w-full h-32 rounded-xl overflow-hidden bg-slate-900 border border-retro-cardBorder">
                        <img
                                id="car-photo-preview"
                                src=""
                                alt="Car preview"
                                class="w-full h-full object-cover"
                                draggable="false"
                        />
                    </div>
                </div>
            </div>

            <button
                    type="submit"
                    class="w-full mt-2 flex items-center justify-center gap-1 px-3 py-2 rounded-xl bg-retro-secondary text-slate-950 font-semibold hover:brightness-105 active:scale-[0.97] transition"
            >
                <i class="fa-solid fa-plus text-[10px]"></i>
                Add Car
            </button>
        </form>
    </div>
</div>

<!-- MODAL ADD NOTE -->
<div id="modal-add-note" class="modal-backdrop hidden">
    <div
            class="w-full max-w-md mx-4 bg-retro-card border border-retro-cardBorder rounded-2xl p-5 text-xs shadow-2xl"
    >
        <div class="flex justify-between items-center mb-3">
            <div class="font-semibold text-sm">Add Note</div>
            <button
                    type="button"
                    data-close-modal="modal-add-note"
                    class="text-retro-muted hover:text-retro-text text-sm"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <form id="form-add-note" class="space-y-3">
            <input type="hidden" name="carId" />
            <div>
                <label class="block text-[11px] text-retro-muted mb-1"
                >Car (e.g. Mustang '67)</label
                >
                <input
                        name="carName"
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                        placeholder="Mustang '67"
                />
            </div>
            <div>
                <label class="block text-[11px] text-retro-muted mb-1">Title</label>
                <input
                        name="title"
                        required
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                        placeholder="Suspension rebuild kit installed"
                />
            </div>
            <div>
                <label class="block text-[11px] text-retro-muted mb-1">Details</label>
                <textarea
                        name="body"
                        rows="3"
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs resize-none"
                        placeholder="What did you do, what’s next…"
                ></textarea>
            </div>
            <div>
                <label class="block text-[11px] text-retro-muted mb-1"
                >Tags (comma separated)</label
                >
                <input
                        name="tags"
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                        placeholder="suspension, parts, todo"
                />
            </div>
            <div>
                <label class="block text-[11px] text-retro-muted mb-1"
                >Status</label
                >
                <select
                        name="status"
                        class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                >
                    <option value="planned">Planned</option>
                    <option value="in_progress">In progress</option>
                    <option value="done">Done</option>
                </select>
            </div>

            <button
                    type="submit"
                    class="w-full mt-2 flex items-center justify-center gap-1 px-3 py-2 rounded-xl bg-retro-secondary text-slate-950 font-semibold hover:brightness-105 active:scale-[0.97] transition"
            >
                <i class="fa-solid fa-plus text-[10px]"></i>
                Add Note
            </button>
        </form>
    </div>
</div>

<!-- MODAL CAR DETAILS -->
<div id="modal-car-details" class="modal-backdrop hidden">
    <div
            class="w-full max-w-lg mx-4 bg-retro-card border border-retro-cardBorder rounded-2xl p-5 text-xs shadow-2xl"
    >
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <div
                        class="w-8 h-8 rounded-xl bg-slate-900 flex items-center justify-center"
                >
                    <i class="fa-solid fa-car-side text-retro-secondary text-sm"></i>
                </div>
                <div>
                    <div id="details-title" class="font-semibold text-sm">
                        Car details
                    </div>
                    <div
                            id="details-subtitle"
                            class="text-[10px] text-retro-muted"
                    ></div>
                </div>
            </div>
            <button
                    type="button"
                    data-close-modal="modal-car-details"
                    class="text-retro-muted hover:text-retro-text text-sm"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div id="details-body" class="space-y-4 text-xs"></div>
    </div>
</div>

<script>
    // NAVIGATION
    const navButtons = document.querySelectorAll(".nav-btn");
    const pages = document.querySelectorAll(".tab-page");

    function showTab(id) {
      pages.forEach((p) => p.classList.remove("active"));
      const page = document.getElementById(id);
      if (page) page.classList.add("active");

      navButtons.forEach((b) => {
        b.classList.remove("text-retro-secondary");
        b.classList.add("text-retro-muted");
      });
      const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
      if (btn) {
        btn.classList.remove("text-retro-muted");
        btn.classList.add("text-retro-secondary");
      }

      if (id === "tab-analytics") {
        setTimeout(() => {
          initCharts();
          resizeCharts();
        }, 40);
      }
    }

    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => showTab(btn.dataset.target));
    });

    // DATA (with maintenance fields, status, etc.)
    let cars = [
      {
        id: "mustang",
        name: "Ford Mustang '67",
        subtitle: "Fastback GT · 390 V8",
        status: "In restoration",
        year: 1967,
        value: 14500,
        notes: 12,
        updated: "2d ago",
        hero: "https://images.pexels.com/photos/210019/pexels-photo-210019.jpeg?auto=compress&w=1200",
        locked: false,
        mileage: 120000,
        lastServiceMileage: 118000,
        lastServiceDate: "2024-09-10",
        serviceIntervalKm: 10000,
      },
      {
        id: "porsche",
        name: "Porsche 911 (964)",
        subtitle: "Turbo 3.6 · Oak Green",
        status: "Complete",
        year: 1991,
        value: 8200,
        notes: 45,
        updated: "1w ago",
        hero: "https://images.pexels.com/photos/1402787/pexels-photo-1402787.jpeg?auto=compress&w=1200",
        locked: false,
        mileage: 175000,
        lastServiceMileage: 170000,
        lastServiceDate: "2024-08-20",
        serviceIntervalKm: 15000,
      },
    ];

    let notes = [
      {
        id: 1,
        carId: "mustang",
        carName: "Mustang '67",
        title: "Suspension rebuild kit installed",
        body: "Upper & lower control arms, bushings, fresh alignment booked for Friday.",
        tags: ["suspension", "parts"],
        date: "Oct 14",
        status: "done",
      },
      {
        id: 2,
        carId: "porsche",
        carName: "Porsche 964",
        title: "Valve adjustment",
        body: "Adjusted valves, replaced valve cover gaskets, filled with 20W-50.",
        tags: ["engine", "maintenance"],
        date: "Oct 11",
        status: "in_progress",
      },
    ];

    const statusStyles = {
      "In restoration":
        "bg-gradient-to-r from-amber-400 to-orange-500 text-black",
      Complete: "bg-emerald-400 text-black",
      "Pending parts": "bg-sky-400 text-black",
    };

    // --- PERSISTENCE (localStorage) ---
    const STORAGE_CARS_KEY = "retronotes_cars_v1";
    const STORAGE_NOTES_KEY = "retronotes_notes_v1";
    const AVATAR_KEY = "retronotes_avatar_dataurl";

    function saveState() {
      try {
        localStorage.setItem(STORAGE_CARS_KEY, JSON.stringify(cars));
        localStorage.setItem(STORAGE_NOTES_KEY, JSON.stringify(notes));
      } catch (e) {
        console.warn("Cannot save state", e);
      }
    }

    function loadState() {
      try {
        const savedCars = localStorage.getItem(STORAGE_CARS_KEY);
        const savedNotes = localStorage.getItem(STORAGE_NOTES_KEY);
        if (savedCars) {
          cars = JSON.parse(savedCars);
        }
        if (savedNotes) {
          notes = JSON.parse(savedNotes);
        }
      } catch (e) {
        console.warn("Cannot load state", e);
      }
    }

    // MODALS HELPERS
    function openModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove("hidden");
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add("hidden");
    }

    document.querySelectorAll("[data-close-modal]").forEach((btn) => {
      btn.addEventListener("click", () => closeModal(btn.dataset.closeModal));
    });

    document.querySelectorAll(".modal-backdrop").forEach((b) => {
      b.addEventListener("click", (e) => {
        if (e.target === b) b.classList.add("hidden");
      });
    });

    // Maintenance calculations
    function getServiceStatus(car) {
      const interval = car.serviceIntervalKm || 10000;
      const lastService = car.lastServiceMileage || 0;
      const current = car.mileage || 0;

      const used = current - lastService;
      const remaining = interval - used;

      let status = "ok";
      if (remaining <= 0) status = "overdue";
      else if (remaining < interval * 0.2) status = "soon";

      return { interval, lastService, current, used, remaining, status };
    }

    // CAR DETAILS MODAL
    function renderCarDetails(car, mode = "view") {
      const titleEl = document.getElementById("details-title");
      const subtitleEl = document.getElementById("details-subtitle");
      const bodyEl = document.getElementById("details-body");
      if (!car || !titleEl || !subtitleEl || !bodyEl) return;

      titleEl.textContent = car.name;
      subtitleEl.textContent = car.subtitle || "";

      bodyEl.innerHTML = "";

      if (mode === "settings") {
        const formWrapper = document.createElement("div");
        formWrapper.innerHTML = `
          <div class="text-[11px] text-retro-muted mb-1.5">
            Edit car details
          </div>
          <form id="form-edit-car" class="space-y-3">
            <div>
              <label class="block text-[11px] text-retro-muted mb-1">Name</label>
              <input
                name="name"
                class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                value="${car.name}"
              />
            </div>
            <div>
              <label class="block text-[11px] text-retro-muted mb-1">Subtitle</label>
              <input
                name="subtitle"
                class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                value="${car.subtitle || ""}"
              />
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Year</label>
                <input
                  name="year"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.year || ""}"
                />
              </div>
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Value, $</label>
                <input
                  name="value"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.value || 0}"
                />
              </div>
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Notes</label>
                <input
                  name="notes"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.notes || 0}"
                />
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Mileage</label>
                <input
                  name="mileage"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.mileage || 0}"
                />
              </div>
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Last service (km)</label>
                <input
                  name="lastServiceMileage"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.lastServiceMileage || 0}"
                />
              </div>
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Service interval</label>
                <input
                  name="serviceIntervalKm"
                  type="number"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.serviceIntervalKm || 10000}"
                />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Status</label>
                <select
                  name="status"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                >
                  <option value="In restoration" ${
                    car.status === "In restoration" ? "selected" : ""
                  }>In restoration</option>
                  <option value="Complete" ${
                    car.status === "Complete" ? "selected" : ""
                  }>Complete</option>
                  <option value="Pending parts" ${
                    car.status === "Pending parts" ? "selected" : ""
                  }>Pending parts</option>
                </select>
              </div>
              <div>
                <label class="block text-[11px] text-retro-muted mb-1">Last updated</label>
                <input
                  name="updated"
                  class="w-full bg-retro-cardSoft border border-retro-cardBorder rounded-xl px-3 py-2 text-xs"
                  value="${car.updated || ""}"
                />
              </div>
            </div>

            <div class="flex items-center justify-between pt-2">
              <div class="flex items-center gap-2 text-[11px]">
                <label class="flex items-center gap-1 cursor-pointer">
                  <input type="checkbox" name="locked" ${
                    car.locked ? "checked" : ""
                  } class="accent-retro-secondary" />
                  <span>Lock car (read‑only)</span>
                </label>
              </div>
              <div class="flex gap-2">
                <button
                  type="button"
                  id="btn-edit-cancel"
                  class="px-3 py-2 rounded-xl bg-slate-800 text-retro-muted text-[11px]"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="px-3 py-2 rounded-xl bg-retro-secondary text-slate-950 text-[11px] font-semibold"
                >
                  Save
                </button>
              </div>
            </div>
          </form>
        `;
        bodyEl.appendChild(formWrapper);

        const form = document.getElementById("form-edit-car");
        const cancelBtn = document.getElementById("btn-edit-cancel");

        cancelBtn.addEventListener("click", () => {
          renderCarDetails(car, "view");
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          car.name = (fd.get("name") || "").toString().trim() || car.name;
          car.subtitle = (fd.get("subtitle") || "").toString();
          car.year = Number(fd.get("year")) || car.year;
          car.value = Number(fd.get("value")) || car.value || 0;
          car.notes = Number(fd.get("notes")) || car.notes || 0;
          car.status = (fd.get("status") || car.status).toString();
          car.updated = (fd.get("updated") || car.updated || "now").toString();
          car.locked = fd.get("locked") === "on";
          car.mileage = Number(fd.get("mileage")) || car.mileage || 0;
          car.lastServiceMileage =
            Number(fd.get("lastServiceMileage")) || car.lastServiceMileage || 0;
          car.serviceIntervalKm =
            Number(fd.get("serviceIntervalKm")) || car.serviceIntervalKm || 10000;

          saveState();
          renderGarage();
          renderCarDetails(car, "view");
        });

        return;
      }

      // VIEW MODE
      const wrapper = document.createElement("div");
      wrapper.className = "space-y-4";

      const statusClass =
        statusStyles[car.status] || "bg-slate-600 text-white";

      const svc = getServiceStatus(car);

      wrapper.innerHTML = `
        <div class="flex gap-3">
          <div class="w-28 h-20 rounded-xl overflow-hidden bg-slate-900 flex-shrink-0">
            <img
              src="${car.hero}"
              alt="${car.name}"
              class="w-full h-full object-cover"
              draggable="false"
            />
          </div>
          <div class="flex-1 text-[11px] space-y-1">
            <div>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${statusClass}">
                <i class="fa-solid fa-wrench mr-1 text-[9px]"></i>${(
                  car.status || ""
                ).toUpperCase()}
              </span>
            </div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-1">
              <div>
                <div class="text-retro-muted">Year</div>
                <div class="font-semibold">${car.year || "—"}</div>
              </div>
              <div>
                <div class="text-retro-muted">Estimated value</div>
                <div class="font-semibold">$${(car.value || 0).toLocaleString()}</div>
              </div>
              <div>
                <div class="text-retro-muted">Notes</div>
                <div class="font-semibold">${car.notes || 0}</div>
              </div>
              <div>
                <div class="text-retro-muted">Last updated</div>
                <div class="font-semibold">${car.updated || "—"}</div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="text-[11px] text-retro-muted mb-1">Maintenance</div>
          <div class="grid grid-cols-2 gap-2 text-[11px]">
            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2">
              <div class="text-retro-muted text-[10px]">Current mileage</div>
              <div class="font-semibold">${(car.mileage || 0).toLocaleString()} km</div>
            </div>
            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2">
              <div class="text-retro-muted text-[10px]">Last service</div>
              <div class="font-semibold">${(car.lastServiceMileage || 0).toLocaleString()} km</div>
            </div>
            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2">
              <div class="text-retro-muted text-[10px]">Interval</div>
              <div class="font-semibold">${svc.interval.toLocaleString()} km</div>
            </div>
            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2">
              <div class="text-retro-muted text-[10px]">Remaining</div>
              <div class="font-semibold">${svc.remaining.toLocaleString()} km</div>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-1">
            <div class="text-[11px] text-retro-muted">Recent notes</div>
            <button
              type="button"
              id="btn-details-add-note"
              class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-retro-secondary text-slate-950 text-[10px] font-semibold"
            >
              <i class="fa-solid fa-plus text-[9px]"></i>Add Note
            </button>
          </div>
          <div id="details-notes" class="space-y-1 max-h-40 overflow-y-auto pr-1">
          </div>
        </div>

        <div class="flex items-center justify-between pt-2 border-t border-retro-cardBorder/60">
          <div class="flex items-center gap-2 text-[11px] text-retro-muted">
            <i class="fa-solid fa-gear text-[10px]"></i>
            <span>Use Settings to edit car or lock updates.</span>
          </div>
          <button
            type="button"
            id="btn-open-settings"
            class="px-3 py-2 rounded-xl bg-slate-800 text-[11px]"
          >
            Open Settings
          </button>
        </div>
      `;

      bodyEl.appendChild(wrapper);

      const notesContainer = document.getElementById("details-notes");
      const recent = notes
        .filter((n) => n.carId === car.id || n.carName === car.name)
        .slice(-5)
        .reverse();

      if (!recent.length) {
        const empty = document.createElement("div");
        empty.className = "text-[11px] text-retro-muted";
        empty.textContent = "No notes yet for this car.";
        notesContainer.appendChild(empty);
      } else {
        recent.forEach((n) => {
          const statusBadge =
            n.status === "done"
              ? '<span class="px-1.5 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 text-[9px] ml-1">Done</span>'
              : n.status === "in_progress"
              ? '<span class="px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-300 text-[9px] ml-1">In progress</span>'
              : '<span class="px-1.5 py-0.5 rounded-full bg-sky-500/20 text-sky-300 text-[9px] ml-1">Planned</span>';

          const item = document.createElement("div");
          item.className =
            "text-[11px] bg-slate-900/70 rounded-lg px-2 py-1.5";
          item.innerHTML = `
            <div class="flex justify-between">
              <span class="font-semibold flex items-center">
                ${n.title} ${statusBadge}
              </span>
              <span class="text-[10px] text-retro-muted">${n.date}</span>
            </div>
            <div class="text-retro-muted line-clamp-2">${n.body || ""}</div>
          `;
          notesContainer.appendChild(item);
        });
      }

      document
        .getElementById("btn-open-settings")
        .addEventListener("click", () => renderCarDetails(car, "settings"));

      document
        .getElementById("btn-details-add-note")
        .addEventListener("click", () => {
          openAddNoteModal({ carId: car.id, carName: car.name });
        });
    }

    function openCarDetails(carId, mode = "view") {
      const car = cars.find((c) => c.id === carId);
      if (!car) return;
      renderCarDetails(car, mode);
      openModal("modal-car-details");
    }

    // GARAGE RENDER
    function renderGarage() {
      const list = document.getElementById("garage-list");
      const summary = document.getElementById("garage-summary");
      if (!list || !summary) return;

      list.innerHTML = "";

      const restorationCount = cars.filter(
        (c) => c.status === "In restoration"
      ).length;
      summary.textContent = `${cars.length} cars · ${restorationCount} Restoration Projects`;

      cars.forEach((car) => {
        const card = document.createElement("article");
        card.className =
          "bg-slate-950/40 border border-retro-cardBorder rounded-3xl overflow-hidden shadow-xl";

        const hero =
          car.hero ||
          "https://images.pexels.com/photos/210019/pexels-photo-210019.jpeg?auto=compress&w=1200";

        const statusClass = statusStyles[car.status] || "bg-slate-600 text-white";

        const lockIcon = car.locked ? "fa-lock" : "fa-unlock";
        const lockTitle = car.locked
          ? "Car is locked: editing disabled"
          : "Tap to lock this car (read‑only)";

        const svc = getServiceStatus(car);
        const serviceLabel =
          svc.status === "overdue"
            ? "Service overdue"
            : svc.status === "soon"
            ? "Service soon"
            : "Next service";
        const serviceValue =
          svc.status === "overdue"
            ? `+${Math.abs(svc.remaining).toLocaleString()} km`
            : `${svc.remaining.toLocaleString()} km left`;

        card.innerHTML = `
          <div class="relative">
            <img src="${hero}" alt="${car.name}" class="w-full h-44 md:h-56 object-cover pointer-events-none select-none" draggable="false" />
            <div class="absolute inset-0 bg-gradient-to-t from-slate-950/90 via-slate-950/30 to-transparent pointer-events-none"></div>

            <div class="absolute top-3 right-3">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-semibold ${statusClass}">
                <i class="fa-solid fa-wrench mr-1 text-[9px]"></i>${(car.status || "").toUpperCase()}
              </span>
            </div>

            <div class="absolute left-4 bottom-4 right-4 flex flex-col md:flex-row md:items-end md:justify-between gap-2">
              <div>
                <div class="text-xs text-slate-300 mb-0.5">${car.subtitle || ""}</div>
                <div class="text-xl md:text-2xl font-bold">${car.name}</div>
              </div>
              <button
                type="button"
                class="inline-flex items-center justify-center self-start md:self-auto gap-1 px-3 py-1.5 rounded-full bg-retro-secondary text-slate-950 text-[11px] font-semibold shadow-lg hover:brightness-105 active:scale-[0.97] transition add-note-from-car"
                data-car-id="${car.id}"
                data-car-name="${car.name}"
              >
                <i class="fa-solid fa-pen text-[9px]"></i>
                Add Note
              </button>
            </div>
          </div>

          <div class="px-4 pt-3 pb-4 bg-slate-950/70">
            <div class="grid grid-cols-3 gap-3 text-[11px] mb-3">
              <div class="bg-slate-900/70 rounded-2xl px-3 py-2 flex flex-col justify-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wide">Notes</div>
                <div class="text-sm font-semibold">${car.notes ?? 0}</div>
              </div>
              <div class="bg-slate-900/70 rounded-2xl px-3 py-2 flex flex-col justify-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wide">Cost</div>
                <div class="text-sm font-semibold">$${(car.value || 0).toLocaleString()}</div>
              </div>
              <div class="bg-slate-900/70 rounded-2xl px-3 py-2 flex flex-col justify-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wide">${serviceLabel}</div>
                <div class="text-sm font-semibold">${serviceValue}</div>
              </div>
            </div>

            <div class="flex items-center justify-between text-[11px] text-slate-400">
              <div class="flex items-center gap-2">
                <button
                  type="button"
                  class="w-7 h-7 rounded-full border border-slate-700 flex items-center justify-center btn-car-settings"
                  title="Car settings"
                  data-car-id="${car.id}"
                >
                  <i class="fa-solid fa-gear text-[10px]"></i>
                </button>
                <button
                  type="button"
                  class="w-7 h-7 rounded-full border border-slate-700 flex items-center justify-center btn-car-lock"
                  title="${lockTitle}"
                  data-car-id="${car.id}"
                >
                  <i class="fa-solid ${lockIcon} text-[10px]"></i>
                </button>
              </div>
              <button
                type="button"
                class="text-retro-secondary hover:underline text-[11px] btn-view-details"
                data-car-id="${car.id}"
              >
                View Details
              </button>
            </div>
          </div>
        `;

        list.appendChild(card);
      });

      // Add Note on card
      list.querySelectorAll(".add-note-from-car").forEach((btn) => {
        btn.addEventListener("click", () => {
          const carId = btn.dataset.carId;
          const car = cars.find((c) => c.id === carId);
          if (car && car.locked) {
            alert("This car is locked. Unlock it in Settings to add notes.");
            return;
          }
          openAddNoteModal({
            carId: btn.dataset.carId,
            carName: btn.dataset.carName,
          });
        });
      });

      // View Details
      list.querySelectorAll(".btn-view-details").forEach((btn) => {
        btn.addEventListener("click", () => {
          openCarDetails(btn.dataset.carId, "view");
        });
      });

      // Settings (gear)
      list.querySelectorAll(".btn-car-settings").forEach((btn) => {
        btn.addEventListener("click", () => {
          openCarDetails(btn.dataset.carId, "settings");
        });
      });

      // Lock / Unlock
      list.querySelectorAll(".btn-car-lock").forEach((btn) => {
        btn.addEventListener("click", () => {
          const car = cars.find((c) => c.id === btn.dataset.carId);
          if (!car) return;
          car.locked = !car.locked;
          saveState();
          renderGarage();
        });
      });

      updateAnalyticsSummary();
      renderTopCars();
    }

    // NOTES LIST
    let filterTodosOnly = false;

    function renderNotes(filter = "") {
      const list = document.getElementById("notes-list");
      const totalNotesEl = document.getElementById("total-notes");
      if (!list) return;
      list.innerHTML = "";

      const q = filter.trim().toLowerCase();

      const filteredNotes = notes
        .slice()
        .reverse()
        .filter((n) => {
          if (filterTodosOnly && n.status === "done") {
            return false;
          }
          if (!q) return true;
          const haystack = (
            (n.title || "") +
            " " +
            (n.body || "") +
            " " +
            (n.carName || "") +
            " " +
            (n.tags || []).join(" ")
          ).toLowerCase();
          return haystack.includes(q);
        });

      filteredNotes.forEach((note) => {
        const el = document.createElement("div");
        el.className =
          "bg-retro-card border border-retro-cardBorder rounded-xl p-3";

        const tagsHtml =
          note.tags && note.tags.length
            ? `<div class="flex flex-wrap gap-1 mt-1">${note.tags
                .map(
                  (t) =>
                    `<span class="px-1.5 py-0.5 rounded-full bg-slate-800 text-[9px] text-slate-300">${t}</span>`
                )
                .join("")}</div>`
            : "";

        const statusBadge =
          note.status === "done"
            ? '<span class="px-1.5 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 text-[9px] ml-1">Done</span>'
            : note.status === "in_progress"
            ? '<span class="px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-300 text-[9px] ml-1">In progress</span>'
            : '<span class="px-1.5 py-0.5 rounded-full bg-sky-500/20 text-sky-300 text-[9px] ml-1">Planned</span>';

        const isDone = note.status === "done";
        const doneBtnLabel = isDone ? "Mark as todo" : "Mark done";

        el.innerHTML = `
          <div class="flex justify-between mb-1">
            <span class="text-[10px] uppercase text-blue-400 flex items-center">
              ${note.carName || "General"} ${statusBadge}
            </span>
            <span class="text-[10px] text-retro-muted">${note.date}</span>
          </div>
          <div class="font-semibold mb-0.5">${note.title}</div>
          <div class="text-retro-muted text-[11px]">
            ${note.body || ""}
          </div>
          ${tagsHtml}
          <div class="mt-2 flex items-center justify-between">
            <button
              type="button"
              class="text-[10px] px-2 py-1 rounded-full border border-retro-cardBorder bg-slate-900/60 hover:border-emerald-400 hover:text-emerald-300 transition btn-toggle-note-status"
              data-note-id="${note.id}"
            >
              ${doneBtnLabel}
            </button>
          </div>
        `;
        list.appendChild(el);
      });

      if (!list.children.length) {
        const empty = document.createElement("div");
        empty.className = "text-[11px] text-retro-muted text-center py-6";
        empty.textContent =
          "No notes yet. Add your first log from Garage or Notes tab.";
        list.appendChild(empty);
      }

      // Update total notes analytics
      if (totalNotesEl) {
        totalNotesEl.textContent = String(notes.length);
      }

      // attach handlers for toggle buttons
      list.querySelectorAll(".btn-toggle-note-status").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = Number(btn.dataset.noteId);
          const note = notes.find((n) => n.id === id);
          if (!note) return;
          note.status = note.status === "done" ? "planned" : "done";
          saveState();
          renderNotes(
            document.getElementById("notes-search")
              ? document.getElementById("notes-search").value
              : ""
          );
        });
      });
    }

    const notesSearchInput = document.getElementById("notes-search");
    if (notesSearchInput) {
      notesSearchInput.addEventListener("input", (e) =>
        renderNotes(e.target.value)
      );
    }

    // Filter todos
    const btnNotesFilterTodos = document.getElementById("btn-notes-filter-todos");
    if (btnNotesFilterTodos) {
      btnNotesFilterTodos.addEventListener("click", () => {
        filterTodosOnly = !filterTodosOnly;
        btnNotesFilterTodos.classList.toggle(
          "border-retro-secondary",
          filterTodosOnly
        );
        btnNotesFilterTodos.classList.toggle(
          "text-retro-secondary",
          filterTodosOnly
        );
        renderNotes(
          notesSearchInput ? notesSearchInput.value : ""
        );
      });
    }

    // header search => Notes tab + focus
    const headerSearchBtn = document.getElementById("header-search");
    if (headerSearchBtn) {
      headerSearchBtn.addEventListener("click", () => {
        showTab("tab-notes");
        setTimeout(() => {
          const search = document.getElementById("notes-search");
          if (search) search.focus();
        }, 80);
      });
    }

    // ------ ADD CAR + CAR PHOTO ------
    const openAddCarBtn = document.getElementById("btn-open-add-car");
    const carPhotoBtnCamera = document.getElementById("btn-car-photo-camera");
    const carPhotoBtnGallery = document.getElementById("btn-car-photo-gallery");
    const carPhotoInputCamera = document.getElementById("car-photo-input-camera");
    const carPhotoInputGallery = document.getElementById("car-photo-input-gallery");
    const carPhotoFilename = document.getElementById("car-photo-filename");
    const carPhotoPreviewWrapper = document.getElementById("car-photo-preview-wrapper");
    const carPhotoPreview = document.getElementById("car-photo-preview");
    const addCarForm = document.getElementById("form-add-car");

    if (openAddCarBtn) {
      openAddCarBtn.addEventListener("click", () => {
        const f = document.getElementById("form-add-car");
        if (f) f.reset();

        if (carPhotoFilename) {
          carPhotoFilename.textContent = "No photo selected";
        }
        if (carPhotoPreviewWrapper) {
          carPhotoPreviewWrapper.classList.add("hidden");
        }
        if (carPhotoPreview) {
          carPhotoPreview.src = "";
        }

        openModal("modal-add-car");
      });
    }

    function handleCarPhotoFile(file) {
      if (!file || !file.type.startsWith("image/")) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        if (carPhotoPreview) {
          carPhotoPreview.src = dataUrl;
        }
        if (carPhotoPreviewWrapper) {
          carPhotoPreviewWrapper.classList.remove("hidden");
        }
        if (carPhotoFilename) {
          carPhotoFilename.textContent = file.name || "Custom photo selected";
        }
        if (addCarForm && addCarForm.heroDataUrl) {
          addCarForm.heroDataUrl.value = dataUrl;
        }
      };
      reader.readAsDataURL(file);
    }

    // Camera (if needed; currently button commented out in HTML)
    if (carPhotoBtnCamera && carPhotoInputCamera) {
      carPhotoBtnCamera.addEventListener("click", () => {
        carPhotoInputCamera.click();
      });

      carPhotoInputCamera.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        handleCarPhotoFile(file);
        carPhotoInputCamera.value = "";
      });
    }

    // Gallery
    if (carPhotoBtnGallery && carPhotoInputGallery) {
      carPhotoBtnGallery.addEventListener("click", () => {
        carPhotoInputGallery.click();
      });

      carPhotoInputGallery.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        handleCarPhotoFile(file);
        carPhotoInputGallery.value = "";
      });
    }

    if (addCarForm) {
      addCarForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);

        const defaultHero =
          "https://images.pexels.com/photos/210019/pexels-photo-210019.jpeg?auto=compress&w=1200&rand=" +
          Math.random();

        const heroDataUrl = (fd.get("heroDataUrl") || "").toString();

        const mileage = Number(fd.get("mileage")) || 0;
        const lastServiceMileage =
          Number(fd.get("lastServiceMileage")) || mileage || 0;
        const intervalKm =
          Number(fd.get("serviceIntervalKm")) || 10000;

        const car = {
          id: "car-" + Date.now(),
          name: (fd.get("name") || "").toString().trim() || "Untitled car",
          subtitle: (fd.get("subtitle") || "").toString(),
          year: Number(fd.get("year")) || new Date().getFullYear(),
          value: Number(fd.get("value")) || 0,
          notes: Number(fd.get("notes")) || 0,
          status: (fd.get("status") || "In restoration").toString(),
          updated: (fd.get("updated") || "now").toString(),
          hero: heroDataUrl || defaultHero,
          locked: false,
          mileage,
          lastServiceMileage,
          lastServiceDate: new Date().toISOString().slice(0, 10),
          serviceIntervalKm: intervalKm,
        };

        cars.push(car);
        saveState();
        closeModal("modal-add-car");
        renderGarage();
      });
    }

    // ADD NOTE
    function openAddNoteModal(opts = {}) {
      const form = document.getElementById("form-add-note");
      if (!form) return;

      if (opts.carId) {
        const car = cars.find((c) => c.id === opts.carId);
        if (car && car.locked) {
          alert("This car is locked. Unlock it in Settings to add notes.");
          return;
        }
      }

      form.reset();
      form.carId.value = opts.carId || "";
      form.carName.value = opts.carName || "";
      openModal("modal-add-note");
    }

    const openAddNoteGlobalBtn = document.getElementById(
      "btn-open-add-note-global"
    );
    if (openAddNoteGlobalBtn) {
      openAddNoteGlobalBtn.addEventListener("click", () => openAddNoteModal());
    }

    const addNoteForm = document.getElementById("form-add-note");
    if (addNoteForm) {
      addNoteForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);

        let carId = (fd.get("carId") || "").toString();
        let carName = (fd.get("carName") || "").toString().trim();

        if (!carName && carId) {
          const car = cars.find((c) => c.id === carId);
          if (car) carName = car.name;
        }

        if (carId) {
          const car = cars.find((c) => c.id === carId);
          if (car && car.locked) {
            alert("This car is locked. Unlock it in Settings to add notes.");
            return;
          }
        }

        const tags = (fd.get("tags") || "")
          .toString()
          .split(",")
          .map((t) => t.trim())
          .filter(Boolean);

        const status = (fd.get("status") || "planned").toString();

        const now = new Date();
        const dateStr = now.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        });

        const note = {
          id: Date.now(),
          carId: carId || null,
          carName: carName || "General",
          title: (fd.get("title") || "Note").toString(),
          body: (fd.get("body") || "").toString(),
          tags,
          date: dateStr,
          status,
        };

        notes.push(note);

        if (note.carId) {
          const car = cars.find((c) => c.id === note.carId);
          if (car) {
            car.notes = (car.notes || 0) + 1;
            car.updated = "now";
          }
        } else if (note.carName) {
          const car = cars.find(
            (c) => c.name.toLowerCase() === note.carName.toLowerCase()
          );
          if (car) {
            car.notes = (car.notes || 0) + 1;
            car.updated = "now";
          }
        }

        saveState();
        closeModal("modal-add-note");
        renderNotes(
          document.getElementById("notes-search")
            ? document.getElementById("notes-search").value
            : ""
        );
        renderGarage();
      });
    }

    // ANALYTICS
    function updateAnalyticsSummary() {
      const totalValue = cars.reduce((sum, c) => sum + (c.value || 0), 0);
      const totalValueEl = document.getElementById("total-value");
      if (totalValueEl) {
        totalValueEl.textContent = "$" + totalValue.toLocaleString();
      }

      const totalNotesEl = document.getElementById("total-notes");
      if (totalNotesEl) {
        totalNotesEl.textContent = String(notes.length);
      }
    }

    let chartsInited = false;

    function initCharts() {
      if (chartsInited) return;
      if (
        !document.getElementById("analytics-pie") ||
        !document.getElementById("analytics-line") ||
        !document.getElementById("analytics-radar")
      )
        return;

      chartsInited = true;

      const pieData = [
        {
          type: "pie",
          values: [12000, 7500, 5200, 3750],
          labels: ["Engine / Drivetrain", "Body & Paint", "Interior", "Other"],
          marker: {
            colors: ["#4d96ff", "#ff4d4d", "#facc15", "#22c55e"],
          },
          textinfo: "label+percent",
          textfont: { color: "#e2e8f0", size: 10 },
          hole: 0.55,
        },
      ];

      const pieLayout = {
        margin: { t: 5, r: 5, b: 5, l: 5 },
        showlegend: false,
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        height: 220,
      };

      Plotly.newPlot("analytics-pie", pieData, pieLayout, {
        displayModeBar: false,
        responsive: true,
      });

      const months = ["May", "Jun", "Jul", "Aug", "Sep", "Oct"];
      const mustang = [900, 1100, 1500, 600, 1300, 800];
      const porsche = [0, 500, 700, 300, 200, 150];

      const lineData = [
        {
          x: months,
          y: mustang,
          type: "scatter",
          mode: "lines+markers",
          name: "Mustang",
          line: { color: "#ff4d4d", width: 2 },
          marker: { size: 5 },
        },
        {
          x: months,
          y: porsche,
          type: "scatter",
          mode: "lines+markers",
          name: "Porsche 964",
          line: { color: "#4d96ff", width: 2 },
          marker: { size: 5 },
        },
      ];

      const lineLayout = {
        margin: { t: 10, r: 10, b: 30, l: 40 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: {
          tickfont: { color: "#94a3b8", size: 10 },
          showgrid: false,
        },
        yaxis: {
          tickfont: { color: "#94a3b8", size: 10 },
          gridcolor: "#1f2937",
        },
        legend: {
          font: { color: "#e2e8f0", size: 9 },
          orientation: "h",
          y: -0.25,
        },
        height: 220,
      };

      Plotly.newPlot("analytics-line", lineData, lineLayout, {
        displayModeBar: false,
        responsive: true,
      });

      renderRadarChart();
    }

    function renderRadarChart() {
      const radarEl = document.getElementById("analytics-radar");
      if (!radarEl || !window.Plotly) return;

      if (!cars.length) {
        radarEl.innerHTML =
          '<div class="text-[11px] text-retro-muted text-center pt-10">Add cars in Garage to see your garage health profile.</div>';
        return;
      }

      // Axes: Restoration, Documentation, Maintenance, Notes, Investment
      const axes = [
        "Restoration",
        "Documentation",
        "Maintenance",
        "Notes density",
        "Investment",
      ];

      const traces = cars.map((car) => {
        const svc = getServiceStatus(car);
        const restorationScore =
          car.status === "Complete"
            ? 100
            : car.status === "In restoration"
            ? 50
            : 70;
        const docsScore = Math.min((car.notes || 0) * 3, 100);
        const maintenanceScore =
          svc.status === "ok"
            ? 100
            : svc.status === "soon"
            ? 70
            : 40;
        const notesScore = Math.min((car.notes || 0) * 2, 100);
        const investmentScore = Math.min((car.value || 0) / 300, 100);

        const values = [
          restorationScore,
          docsScore,
          maintenanceScore,
          notesScore,
          investmentScore,
          restorationScore, // close loop
        ];

        return {
          type: "scatterpolar",
          r: values,
          theta: [...axes, axes[0]],
          fill: "toself",
          name: car.name,
        };
      });

      const layout = {
        margin: { t: 10, r: 10, b: 10, l: 10 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        polar: {
          bgcolor: "rgba(15,23,42,0.8)",
          radialaxis: {
            visible: false,
            range: [0, 100],
          },
          angularaxis: {
            tickfont: { color: "#94a3b8", size: 9 },
          },
        },
        legend: {
          font: { color: "#e2e8f0", size: 9 },
        },
        height: 220,
      };

      Plotly.newPlot(radarEl, traces, layout, {
        displayModeBar: false,
        responsive: true,
      });
    }

    function resizeCharts() {
      if (!chartsInited || !window.Plotly) return;
      try {
        Plotly.Plots.resize("analytics-pie");
        Plotly.Plots.resize("analytics-line");
        Plotly.Plots.resize("analytics-radar");
      } catch (e) {
        console.warn("resize error", e);
      }
    }
    window.addEventListener("resize", resizeCharts);

    // TOP CARS
    let topMode = "cost";

    function renderTopCars() {
      const list = document.getElementById("top-list");
      const titleEl = document.getElementById("top-highlight-title");
      const mainEl = document.getElementById("top-highlight-main");
      const subEl = document.getElementById("top-highlight-sub");
      const badgeEl = document.getElementById("top-highlight-badge");

      if (!list || !titleEl || !mainEl || !subEl || !badgeEl) return;

      list.innerHTML = "";

      if (!cars.length) {
        titleEl.textContent = "No cars yet";
        mainEl.textContent = "–";
        subEl.textContent = "Add cars in Garage to see rankings";
        badgeEl.innerHTML =
          '<i class="fa-solid fa-circle-info mr-1"></i>No data';
        return;
      }

      const nowYear = new Date().getFullYear();

      // spendingMap основан на значении value как прокси для потраченных денег
      const spendingMap = {};
      cars.forEach((c) => {
        spendingMap[c.id] = Math.round((c.value || 0) * 0.7);
      });

      let sorted = [...cars];

      if (topMode === "cost") {
        sorted.sort((a, b) => (b.value || 0) - (a.value || 0));
      } else if (topMode === "spending") {
        sorted.sort(
          (a, b) => (spendingMap[b.id] || 0) - (spendingMap[a.id] || 0)
        );
      } else {
        sorted.sort((a, b) => (a.year || nowYear) - (b.year || nowYear));
      }

      const best = sorted[0];

      if (topMode === "cost") {
        badgeEl.innerHTML =
          '<i class="fa-solid fa-crown mr-1"></i>Most valuable';
        titleEl.textContent = best.name;
        mainEl.textContent = "$" + (best.value || 0).toLocaleString();
        subEl.textContent = "Estimated market value";
      } else if (topMode === "spending") {
        badgeEl.innerHTML =
          '<i class="fa-solid fa-fire mr-1"></i>Most money spent';
        titleEl.textContent = best.name;
        mainEl.textContent =
          "$" + (spendingMap[best.id] || 0).toLocaleString();
        subEl.textContent = "Estimated lifetime spending";
      } else {
        const age = nowYear - (best.year || nowYear);
        badgeEl.innerHTML =
          '<i class="fa-solid fa-hourglass-half mr-1"></i>Oldest';
        titleEl.textContent = best.name;
        mainEl.textContent = age + " yrs";
        subEl.textContent = `Since ${best.year}`;
      }

      sorted.forEach((car, idx) => {
        const row = document.createElement("div");
        row.className =
          "flex items-center justify-between bg-retro-card border border-retro-cardBorder rounded-xl px-3 py-2";

        let right;
        if (topMode === "cost") {
          right = "$" + (car.value || 0).toLocaleString();
        } else if (topMode === "spending") {
          right = "$" + (spendingMap[car.id] || 0).toLocaleString();
        } else {
          right = nowYear - (car.year || nowYear) + " yrs";
        }

        row.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-5 text-[11px] text-retro-muted">${idx + 1}</div>
            <div>
              <div class="text-xs font-semibold">${car.name}</div>
              <div class="text-[10px] text-retro-muted">Year ${car.year}</div>
            </div>
          </div>
          <div class="text-xs font-semibold">${right}</div>
        `;
        list.appendChild(row);
      });
    }

    document
      .querySelectorAll("#top-mode-switch button")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll("#top-mode-switch button")
            .forEach((b) => {
              b.className = "flex-1 py-1.5 rounded-lg text-retro-muted";
            });
          btn.className =
            "flex-1 py-1.5 rounded-lg bg-retro-secondary text-slate-950 font-semibold";

          topMode = btn.dataset.mode;
          renderTopCars();
        });
      });

    // AVATAR CHANGE (localStorage)
    const avatarBtn = document.getElementById("avatar-button");
    const avatarImg = document.getElementById("avatar-img");
    const avatarInput = document.getElementById("avatar-input");

    function loadAvatarFromStorage() {
      try {
        const saved = localStorage.getItem(AVATAR_KEY);
        if (saved && avatarImg) {
          avatarImg.src = saved;
        }
      } catch (e) {
        console.warn("Cannot load avatar from storage", e);
      }
    }

    function handleAvatarFile(file) {
      if (!file || !file.type.startsWith("image/")) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        avatarImg.src = dataUrl;
        try {
          localStorage.setItem(AVATAR_KEY, dataUrl);
        } catch (err) {
          console.warn("Cannot save avatar to storage", err);
        }
      };
      reader.readAsDataURL(file);
    }

    if (avatarBtn && avatarInput && avatarImg) {
      avatarBtn.addEventListener("click", () => {
        avatarInput.click();
      });

      avatarInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        handleAvatarFile(file);
        avatarInput.value = "";
      });
    }

    // Export / Import JSON
    function exportData() {
      const data = { cars, notes, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "retronotes_garage_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importDataFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!parsed || !Array.isArray(parsed.cars) || !Array.isArray(parsed.notes)) {
            alert("Invalid backup file");
            return;
          }
          cars = parsed.cars;
          notes = parsed.notes;
          saveState();
          renderGarage();
          renderNotes(
            document.getElementById("notes-search")
              ? document.getElementById("notes-search").value
              : ""
          );
          updateAnalyticsSummary();
          renderTopCars();
          if (chartsInited) renderRadarChart();
        } catch (err) {
          alert("Error importing backup");
        }
      };
      reader.readAsText(file);
    }

    const btnExportData = document.getElementById("btn-export-data");
    const inputImportData = document.getElementById("input-import-data");

    if (btnExportData) {
      btnExportData.addEventListener("click", exportData);
    }
    if (inputImportData) {
      inputImportData.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) importDataFromFile(file);
        inputImportData.value = "";
      });
    }

    // INIT
    window.addEventListener("load", () => {
      loadState();
      loadAvatarFromStorage();
      renderGarage();
      renderNotes();
      updateAnalyticsSummary();
      renderTopCars();
    });
</script>
</body>
</html>